

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tiledtmxloader.tiledtmxloader &mdash; pytmxloader 3.0.1.97 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.0.1.97',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="pytmxloader 3.0.1.97 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pytmxloader 3.0.1.97 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tiledtmxloader.tiledtmxloader</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">TileMap loader for python for Tiled, a generic tile map editor</span>
<span class="sd">from http://mapeditor.org/ .</span>
<span class="sd">It loads the \*.tmx files produced by Tiled.</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Versioning scheme based on: http://en.wikipedia.org/wiki/Versioning#Designating_development_stage</span>
<span class="c">#</span>
<span class="c">#   +-- api change, probably incompatible with older versions</span>
<span class="c">#   |     +-- enhancements but no api change</span>
<span class="c">#   |     |</span>
<span class="c"># major.minor[.build[.revision]]</span>
<span class="c">#                |</span>
<span class="c">#                +-|* 0 for alpha (status)</span>
<span class="c">#                  |* 1 for beta (status)</span>
<span class="c">#                  |* 2 for release candidate</span>
<span class="c">#                  |* 3 for (public) release</span>
<span class="c">#</span>
<span class="c"># For instance:</span>
<span class="c">#     * 1.2.0.1 instead of 1.2-a</span>
<span class="c">#     * 1.2.1.2 instead of 1.2-b2 (beta with some bug fixes)</span>
<span class="c">#     * 1.2.2.3 instead of 1.2-rc (release candidate)</span>
<span class="c">#     * 1.2.3.0 instead of 1.2-r (commercial distribution)</span>
<span class="c">#     * 1.2.3.5 instead of 1.2-r5 (commercial distribution with many bug fixes)</span>

<span class="n">__revision__</span> <span class="o">=</span> <span class="s">&quot;$Rev: 77 $&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;3.0.0.&quot;</span> <span class="o">+</span> <span class="n">__revision__</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">u&#39;DR0ID @ 2009-2011&#39;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="c"># the following few lines are needed to use logging if this module used without</span>
<span class="c"># a previous call to logging.basicConfig()</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;tiledtmxloader&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> loading ...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__name__</span><span class="p">))</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">_START_TIME</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c">#  -----------------------------------------------------------------------------</span>


<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span><span class="p">,</span> <span class="n">Node</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">array</span>

<span class="c">#  -----------------------------------------------------------------------------</span>
<div class="viewcode-block" id="TileMap"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileMap">[docs]</a><span class="k">class</span> <span class="nc">TileMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>

<span class="sd">    The TileMap holds all the map data.</span>

<span class="sd">    :Ivariables:</span>
<span class="sd">        orientation : string</span>
<span class="sd">            orthogonal or isometric or hexagonal or shifted</span>
<span class="sd">        tilewidth : int</span>
<span class="sd">            width of the tiles (for all layers)</span>
<span class="sd">        tileheight : int</span>
<span class="sd">            height of the tiles (for all layers)</span>
<span class="sd">        width : int</span>
<span class="sd">            width of the map (number of tiles)</span>
<span class="sd">        height : int</span>
<span class="sd">            height of the map (number of tiles)</span>
<span class="sd">        version : string</span>
<span class="sd">            version of the map format</span>
<span class="sd">        tile_sets : list</span>
<span class="sd">            list of TileSet</span>
<span class="sd">        properties : dict</span>
<span class="sd">            the propertis set in the editor, name-value pairs, strings</span>
<span class="sd">        pixel_width : int</span>
<span class="sd">            width of the map in pixels</span>
<span class="sd">        pixel_height : int</span>
<span class="sd">            height of the map in pixels</span>
<span class="sd">        layers : list</span>
<span class="sd">            list of TileLayer</span>
<span class="sd">        map_file_name : dict</span>
<span class="sd">            file name of the map</span>
<span class="sd">        named_layers : dict of string:TledLayer</span>
<span class="sd">            dict containing {name : TileLayer}</span>
<span class="sd">        named_tile_sets : dict</span>
<span class="sd">            dict containing {name : TileSet}</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c">#        This is the top container for all data. The gid is the global id (for a image).</span>
<span class="c">#        Before calling convert most of the values are strings. Some additional</span>
<span class="c">#        values are also calculated, see convert() for details. After calling</span>
<span class="c">#        convert, most values are integers or floats where appropriat.</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        The TileMap holds all the map data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># set through parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tileheight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_sets</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># TileSet</span>
        <span class="c"># ISSUE 9: object groups should be in the same order as layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># WorldTileLayer &lt;- what order? back to front (guessed)</span>
        <span class="c"># self.object_groups = []</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {name: value}</span>
        <span class="c"># additional info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">named_layers</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {name: layer}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">named_tile_sets</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {name: tile_set}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_file_name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

<div class="viewcode-block" id="TileMap.convert"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileMap.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        Converts numerical values from strings to numerical values.</span>
<span class="sd">        It also calculates or set additional data:</span>
<span class="sd">        pixel_width</span>
<span class="sd">        pixel_height</span>
<span class="sd">        named_layers</span>
<span class="sd">        named_tile_sets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tileheight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tileheight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tileheight</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="c"># ISSUE 9</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">is_object_group</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">tileheight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tileheight</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">named_layers</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">tile_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_sets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">named_tile_sets</span><span class="p">[</span><span class="n">tile_set</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_set</span>
            <span class="n">tile_set</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_set</span><span class="o">.</span><span class="n">spacing</span><span class="p">)</span>
            <span class="n">tile_set</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_set</span><span class="o">.</span><span class="n">margin</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">tile_set</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">trans</span><span class="p">:</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">trans</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">trans</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">trans</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="mi">16</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TileMap.decode"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileMap.decode">[docs]</a>    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        Decodes the TileLayer encoded_content and saves it in decoded_content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">is_object_group</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="c">#  -----------------------------------------------------------------------------</span>

</div></div>
<div class="viewcode-block" id="TileSet"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileSet">[docs]</a><span class="k">class</span> <span class="nc">TileSet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    A tileset holds the tiles and its images.</span>

<span class="sd">    :Ivariables:</span>
<span class="sd">        firstgid : int</span>
<span class="sd">            the first gid of this tileset</span>
<span class="sd">        name : string</span>
<span class="sd">            the name of this TileSet</span>
<span class="sd">        images : list</span>
<span class="sd">            list of TileImages</span>
<span class="sd">        tiles : list</span>
<span class="sd">            list of Tiles</span>
<span class="sd">        indexed_images : dict</span>
<span class="sd">            after calling load() it is dict containing id: image</span>
<span class="sd">        spacing : int</span>
<span class="sd">            the spacing between tiles</span>
<span class="sd">        marging : int</span>
<span class="sd">            the marging of the tiles</span>
<span class="sd">        properties : dict</span>
<span class="sd">            the propertis set in the editor, name-value pairs</span>
<span class="sd">        tilewidth : int</span>
<span class="sd">            the actual width of the tile, can be different from the tilewidth of the map</span>
<span class="sd">        tilehight : int</span>
<span class="sd">            the actual hight of th etile, can be different from the tilehight of the  map</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstgid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># TileImage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tiles</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Tile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexed_images</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {id:image}</span>
        <span class="c"># self.indexed_tiles = {} # {gid: (offsetx, offsety, image} &lt;- actually in map data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tileheight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c">#  -----------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="TileImage"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileImage">[docs]</a><span class="k">class</span> <span class="nc">TileImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    An image of a tile or just an image.</span>

<span class="sd">    :Ivariables:</span>
<span class="sd">        id : int</span>
<span class="sd">            id of this image (has nothing to do with gid)</span>
<span class="sd">        format : string</span>
<span class="sd">            the format as string, only &#39;png&#39; at the moment</span>
<span class="sd">        source : string</span>
<span class="sd">            filename of the image. either this is set or the content</span>
<span class="sd">        encoding : string</span>
<span class="sd">            encoding of the content</span>
<span class="sd">        trans : tuple of (r,g,b)</span>
<span class="sd">            the colorkey color, raw as hex, after calling convert just a (r,g,b) tuple</span>
<span class="sd">        properties : dict</span>
<span class="sd">            the propertis set in the editor, name-value pairs</span>
<span class="sd">        image : TileImage</span>
<span class="sd">            after calling load the pygame surface</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># from &lt;data&gt;...&lt;/data&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># from &lt;data&gt;...&lt;/data&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {name: value}</span>

<span class="c">#  -----------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Tile"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.Tile">[docs]</a><span class="k">class</span> <span class="nc">Tile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    A single tile.</span>

<span class="sd">    :Ivariables:</span>
<span class="sd">        id : int</span>
<span class="sd">            id of the tile gid = TileSet.firstgid + Tile.id</span>
<span class="sd">        images : list of :class:TileImage</span>
<span class="sd">            list of TileImage, either its &#39;id&#39; or &#39;image data&#39; will be set</span>
<span class="sd">        properties : dict of name:value</span>
<span class="sd">            the propertis set in the editor, name-value pairs</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="c"># [20:22]	DR0ID_: to sum up: there are two use cases,</span>
<span class="c"># if the tile element has a child element &#39;image&#39; then tile is</span>
<span class="c"># standalone with its own id and</span>
<span class="c"># the other case where a tileset is present then it</span>
<span class="c"># referes to the image with that id in the tileset</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># uses TileImage but either only id will be set or image data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {name: value}</span>

<span class="c">#  -----------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="TileLayer"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileLayer">[docs]</a><span class="k">class</span> <span class="nc">TileLayer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    A layer of the world.</span>

<span class="sd">    :Ivariables:</span>
<span class="sd">        x : int</span>
<span class="sd">            position of layer in the world in number of tiles (not pixels)</span>
<span class="sd">        y : int</span>
<span class="sd">            position of layer in the world in number of tiles (not pixels)</span>
<span class="sd">        width : int</span>
<span class="sd">            number of tiles in x direction</span>
<span class="sd">        height : int</span>
<span class="sd">            number of tiles in y direction</span>
<span class="sd">        pixel_width : int</span>
<span class="sd">            width of layer in pixels</span>
<span class="sd">        pixel_height : int</span>
<span class="sd">            height of layer in pixels</span>
<span class="sd">        name : string</span>
<span class="sd">            name of this layer</span>
<span class="sd">        opacity : float</span>
<span class="sd">            float from 0 (full transparent) to 1.0 (opaque)</span>
<span class="sd">        decoded_content : list</span>
<span class="sd">            list of graphics id going through the map::</span>

<span class="sd">                e.g [1, 1, 1, ]</span>
<span class="sd">                where decoded_content[0]   is (0,0)</span>
<span class="sd">                      decoded_content[1]   is (1,0)</span>
<span class="sd">                      ...</span>
<span class="sd">                      decoded_content[w]   is (width,0)</span>
<span class="sd">                      decoded_content[w+1] is (0,1)</span>
<span class="sd">                      ...</span>
<span class="sd">                      decoded_content[w * h]  is (width,height)</span>

<span class="sd">                usage: graphics id = decoded_content[tile_x + tile_y * width]</span>
<span class="sd">        content2D : list</span>
<span class="sd">            list of list, usage: graphics id = content2D[x][y]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opacity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoded_content</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {name: value}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content2D</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_object_group</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c"># ISSUE 9</span>


<div class="viewcode-block" id="TileLayer.decode"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileLayer.decode">[docs]</a>    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_map</span><span class="p">):</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        Converts the contents in a list of integers which are the gid of the used</span>
<span class="sd">        tiles. If necessairy it decodes and uncompresses the contents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoded_content</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoded_content</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">u&#39;base64&#39;</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">decode_base64</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">u&#39;csv&#39;</span><span class="p">:</span>
                    <span class="n">list_of_lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">list_of_lines</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span> <span class="k">if</span> <span class="n">val</span><span class="p">])</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">u&#39;unknown data encoding </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># in the case of xml the encoded_content already contains a list of integers</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoded_content</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="s">u&#39;gzip&#39;</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">decompress_gzip</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="s">u&#39;zlib&#39;</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">decompress_zlib</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">u&#39;unknown data compression </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">u&#39;no encoded content to decode&#39;</span><span class="p">)</span>

        <span class="n">struc</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="s">&quot;I&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="n">struc_unpack_from</span> <span class="o">=</span> <span class="n">struc</span><span class="o">.</span><span class="n">unpack_from</span>
        <span class="n">self_decoded_content_extend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span><span class="o">.</span><span class="n">extend</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">struc_unpack_from</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="n">self_decoded_content_extend</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">)</span>
        <span class="n">arr</span><span class="o">.</span><span class="n">fromlist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span> <span class="o">=</span> <span class="n">arr</span>

        <span class="c"># TODO: generate property grid here??</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gen_2D</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_gen_2D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content2D</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># generate the needed lists and fill them</span>
        <span class="k">for</span> <span class="n">xpos</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content2D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ypos</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">content2D</span><span class="p">[</span><span class="n">xpos</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span><span class="p">[</span><span class="n">xpos</span> <span class="o">+</span> <span class="n">ypos</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">])</span>

<div class="viewcode-block" id="TileLayer.pretty_print"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileLayer.pretty_print">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">u&quot;&quot;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoded_content</span><span class="p">[</span><span class="n">num</span><span class="p">])</span>
                <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="n">s</span>
</div>
<div class="viewcode-block" id="TileLayer.convert"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileLayer.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opacity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opacity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tileheight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible</span><span class="p">))</span>

    <span class="c"># def get_visible_tile_range(self, xmin, ymin, xmax, ymax):</span>
        <span class="c"># tile_w = self.pixel_width / self.width</span>
        <span class="c"># tile_h = self.pixel_height / self.height</span>
        <span class="c"># left = int(round(float(xmin) / tile_w)) - 1</span>
        <span class="c"># right = int(round(float(xmax) / tile_w)) + 2</span>
        <span class="c"># top = int(round(float(ymin) / tile_h)) - 1</span>
        <span class="c"># bottom = int(round(float(ymax) / tile_h)) + 2</span>
        <span class="c"># return (left, top, left - right, top - bottom)</span>

    <span class="c"># def get_tiles(self, xmin, ymin, xmax, ymax):</span>
        <span class="c"># tiles = []</span>
        <span class="c"># if self.visible:</span>
            <span class="c"># for ypos in range(ymin, ymax):</span>
                <span class="c"># for xpos in range(xmin, xmax):</span>
                    <span class="c"># try:</span>
                        <span class="c"># img_idx = self.content2D[xpos][ypos]</span>
                        <span class="c"># if img_idx:</span>
                            <span class="c"># tiles.append((xpos, ypos, img_idx))</span>
                    <span class="c"># except IndexError:</span>
                        <span class="c"># pass</span>
        <span class="c"># return tiles</span>

<span class="c">#  -----------------------------------------------------------------------------</span>

</div></div>
<div class="viewcode-block" id="MapObjectGroupLayer"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.MapObjectGroupLayer">[docs]</a><span class="k">class</span> <span class="nc">MapObjectGroupLayer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    Group of objects on the map.</span>

<span class="sd">    :Ivariables:</span>
<span class="sd">        x : int</span>
<span class="sd">            the x position</span>
<span class="sd">        y : int</span>
<span class="sd">            the y position</span>
<span class="sd">        width : int</span>
<span class="sd">            width of the bounding box (usually 0, so no use)</span>
<span class="sd">        height : int</span>
<span class="sd">            height of the bounding box (usually 0, so no use)</span>
<span class="sd">        name : string</span>
<span class="sd">            name of the group</span>
<span class="sd">        objects : list</span>
<span class="sd">            list of the map objects</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {name: value}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_object_group</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># ISSUE 9</span>

<div class="viewcode-block" id="MapObjectGroupLayer.convert"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.MapObjectGroupLayer.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">map_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="n">map_obj</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map_obj</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">map_obj</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map_obj</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">map_obj</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map_obj</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="n">map_obj</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map_obj</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

<span class="c">#  -----------------------------------------------------------------------------</span>
</div></div>
<div class="viewcode-block" id="MapObject"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.MapObject">[docs]</a><span class="k">class</span> <span class="nc">MapObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    A single object on the map.</span>

<span class="sd">    :Ivariables:</span>
<span class="sd">        x : int</span>
<span class="sd">            x position relative to group x position</span>
<span class="sd">        y : int</span>
<span class="sd">            y position relative to group y position</span>
<span class="sd">        width : int</span>
<span class="sd">            width of this object</span>
<span class="sd">        height : int</span>
<span class="sd">            height of this object</span>
<span class="sd">        type : string</span>
<span class="sd">            the type of this object</span>
<span class="sd">        image_source : string</span>
<span class="sd">            source path of the image for this object</span>
<span class="sd">        image : :class:TileImage</span>
<span class="sd">            after loading this is the pygame surface containing the image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_source</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {name: value}</span>

<span class="c">#  -----------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="decode_base64"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.decode_base64">[docs]</a><span class="k">def</span> <span class="nf">decode_base64</span><span class="p">(</span><span class="n">in_str</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    Decodes a base64 string and returns it.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        in_str : string</span>
<span class="sd">            base64 encoded string</span>

<span class="sd">    :returns: decoded string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">decodestring</span><span class="p">(</span><span class="n">in_str</span><span class="p">)</span>

<span class="c">#  -----------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="decompress_gzip"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.decompress_gzip">[docs]</a><span class="k">def</span> <span class="nf">decompress_gzip</span><span class="p">(</span><span class="n">in_str</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    Uncompresses a gzip string and returns it.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        in_str : string</span>
<span class="sd">            gzip compressed string</span>

<span class="sd">    :returns: uncompressed string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">gzip</span>
    <span class="c"># gzip can only handle file object therefore using StringIO</span>
    <span class="n">copmressed_stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">in_str</span><span class="p">)</span>
    <span class="n">gzipper</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">copmressed_stream</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">gzipper</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">gzipper</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="c">#  -----------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="decompress_zlib"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.decompress_zlib">[docs]</a><span class="k">def</span> <span class="nf">decompress_zlib</span><span class="p">(</span><span class="n">in_str</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    Uncompresses a zlib string and returns it.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        in_str : string</span>
<span class="sd">            zlib compressed string</span>

<span class="sd">    :returns: uncompressed string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">zlib</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">in_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#  -----------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="printer"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.printer">[docs]</a><span class="k">def</span> <span class="nf">printer</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ident</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    Helper function, prints a hirarchy of objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">inspect</span>
    <span class="k">print</span> <span class="n">ident</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">ident</span> <span class="o">+=</span> <span class="s">&#39;    &#39;</span>
    <span class="n">lists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">u&#39;decoded_content&#39;</span><span class="p">:</span>
            <span class="n">lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">u&#39;data&#39;</span> <span class="ow">and</span> <span class="n">elem</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">ident</span> <span class="o">+</span> <span class="s">u&#39;data = &#39;</span>
                    <span class="n">printer</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">ident</span> <span class="o">+</span> <span class="s">&#39;    &#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">ident</span> <span class="o">+</span> <span class="s">u&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="s">= </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">printer</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ident</span> <span class="o">+</span> <span class="s">&#39;    &#39;</span><span class="p">)</span>

<span class="c">#  -----------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="VersionError"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.VersionError">[docs]</a><span class="k">class</span> <span class="nc">VersionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

<span class="c">#  -----------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="TileMapParser"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileMapParser">[docs]</a><span class="k">class</span> <span class="nc">TileMapParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">    Allows to parse and decode map files for &#39;Tiled&#39;, a open source map editor</span>
<span class="sd">    written in java. It can be found here: http://mapeditor.org/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_build_tile_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_set_node</span><span class="p">,</span> <span class="n">world_map</span><span class="p">):</span>
        <span class="n">tile_set</span> <span class="o">=</span> <span class="n">TileSet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">tile_set_node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tile_set</span><span class="p">,</span> <span class="s">&quot;source&quot;</span><span class="p">):</span>
            <span class="n">tile_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_tsx</span><span class="p">(</span><span class="n">tile_set</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">world_map</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tile_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tile_set</span><span class="p">(</span><span class="n">tile_set_node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_file_name</span><span class="p">)</span>
        <span class="n">world_map</span><span class="o">.</span><span class="n">tile_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tile_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_tsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">world_map</span><span class="p">):</span>
        <span class="c"># ISSUE 5: the *.tsx file is probably relative to the *.tmx file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
            <span class="c"># print &quot;map file name&quot;, self.map_file_name</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_file_name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="c"># print &quot;tsx filename: &quot;, file_name</span>
        <span class="c"># would be more elegant to use  &quot;with open(file_name, &quot;rb&quot;) as file:&quot; but that is python 2.6</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">dom</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">file</span><span class="p">:</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">dom</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">&#39;tileset&#39;</span><span class="p">):</span>
            <span class="n">tile_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tile_set</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">tile_set</span>

    <span class="k">def</span> <span class="nf">_get_tile_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_set_node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">base_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">tile_set_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;image&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_tile_set_image</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">base_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">tile_set_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;tile&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_tile_set_tile</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">tile_set_node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tile_set</span>

    <span class="k">def</span> <span class="nf">_build_tile_set_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">base_path</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">TileImage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">image_node</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        <span class="c"># id of TileImage has to be set!! -&gt; Tile.TileImage will only have id set</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">image_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;data&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nodeValue</span>
        <span class="n">image</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_abs_path</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="c"># ISSUE 5</span>
        <span class="n">tile_set</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_abs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">relative</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">relative</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">relative</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">relative</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_build_tile_set_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_set_node</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">):</span>
        <span class="n">tile</span> <span class="o">=</span> <span class="n">Tile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">tile_set_node</span><span class="p">,</span> <span class="n">tile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">tile_set_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;image&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_tile_set_tile_image</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tile</span><span class="p">)</span>
        <span class="n">tile_set</span><span class="o">.</span><span class="n">tiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_tile_set_tile_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_node</span><span class="p">,</span> <span class="n">tile</span><span class="p">):</span>
        <span class="n">tile_image</span> <span class="o">=</span> <span class="n">TileImage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">tile_node</span><span class="p">,</span> <span class="n">tile_image</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">tile_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;data&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tile_image</span><span class="p">)</span>
            <span class="n">tile_image</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nodeValue</span>
        <span class="n">tile</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tile_image</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_node</span><span class="p">,</span> <span class="n">world_map</span><span class="p">):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">TileLayer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">layer_node</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">layer_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;data&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">encoded_content</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lastChild</span><span class="o">.</span><span class="n">nodeValue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#print &#39;has childnodes&#39;, node.hasChildNodes()</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">encoded_content</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">nodeType</span> <span class="o">==</span> <span class="n">Node</span><span class="o">.</span><span class="n">ELEMENT_NODE</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">nodeName</span> <span class="o">==</span> <span class="s">&quot;tile&quot;</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&quot;gid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nodeValue</span>
                        <span class="c">#print child, val</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">encoded_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">world_map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_world_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world_node</span><span class="p">):</span>
        <span class="n">world_map</span> <span class="o">=</span> <span class="n">TileMap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">world_node</span><span class="p">,</span> <span class="n">world_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">world_map</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="s">u&quot;1.0&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">VersionError</span><span class="p">(</span><span class="s">u&#39;this parser was made for maps of version 1.0, found version </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">world_map</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">world_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;tileset&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_tile_set</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">world_map</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">world_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;layer&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_layer</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">world_map</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">world_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;objectgroup&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_object_groups</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">world_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">world_map</span>

    <span class="k">def</span> <span class="nf">_build_object_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_group_node</span><span class="p">,</span> <span class="n">world_map</span><span class="p">):</span>
        <span class="n">object_group</span> <span class="o">=</span> <span class="n">MapObjectGroupLayer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">object_group_node</span><span class="p">,</span>  <span class="n">object_group</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">object_group_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;object&#39;</span><span class="p">):</span>
            <span class="n">tiled_object</span> <span class="o">=</span> <span class="n">MapObject</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tiled_object</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">img_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;image&#39;</span><span class="p">):</span>
                <span class="n">tiled_object</span><span class="o">.</span><span class="n">image_source</span> <span class="o">=</span> <span class="n">img_node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">u&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nodeValue</span>
            <span class="n">object_group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tiled_object</span><span class="p">)</span>
        <span class="c"># ISSUE 9</span>
        <span class="n">world_map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">object_group</span><span class="p">)</span>

    <span class="c"># -- helpers -- #</span>
    <span class="k">def</span> <span class="nf">_get_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">nodeType</span> <span class="o">==</span> <span class="n">Node</span><span class="o">.</span><span class="n">ELEMENT_NODE</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">nodeName</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">_set_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_properties</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">properties_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;properties&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">property_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">properties_node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">u&#39;property&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">props</span><span class="p">[</span><span class="n">property_node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">u&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nodeValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">property_node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">u&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nodeValue</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">props</span><span class="p">[</span><span class="n">property_node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s">u&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nodeValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">property_node</span><span class="o">.</span><span class="n">lastChild</span><span class="o">.</span><span class="n">nodeValue</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>


    <span class="c"># -- parsers -- #</span>
<div class="viewcode-block" id="TileMapParser.parse"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileMapParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        Parses the given map. Does no decoding nor loading of the data.</span>
<span class="sd">        :return: instance of TileMap</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># would be more elegant to use  &quot;with open(file_name, &quot;rb&quot;) as tmx_file:&quot; but that is python 2.6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">tmx_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmx_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_file_name</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">dom</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">tmx_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tmx_file</span><span class="p">:</span>
                <span class="n">tmx_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes</span><span class="p">(</span><span class="n">dom</span><span class="o">.</span><span class="n">childNodes</span><span class="p">,</span> <span class="s">&#39;map&#39;</span><span class="p">):</span>
            <span class="n">world_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_world_map</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">world_map</span><span class="o">.</span><span class="n">map_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_file_name</span>
        <span class="n">world_map</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">world_map</span>
</div>
<div class="viewcode-block" id="TileMapParser.parse_decode"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.TileMapParser.parse_decode">[docs]</a>    <span class="k">def</span> <span class="nf">parse_decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        Parses the map but additionally decodes the data.</span>
<span class="sd">        :return: instance of TileMap</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">world_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">printer</span><span class="p">(</span><span class="n">world_map</span><span class="p">)</span>
        <span class="n">world_map</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">world_map</span>


<span class="c">#  -----------------------------------------------------------------------------</span>
</div></div>
<div class="viewcode-block" id="AbstractResourceLoader"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.AbstractResourceLoader">[docs]</a><span class="k">class</span> <span class="nc">AbstractResourceLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for the resource loader.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">FLIP_X</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span>
    <span class="n">FLIP_Y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexed_tiles</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># {gid: (offsetx, offsety, image}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_map</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_img_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">colorkey</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="c"># -&gt; image</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        Load a single image.</span>

<span class="sd">        :Parameters:</span>
<span class="sd">            filename : string</span>
<span class="sd">                Path to the file to be loaded.</span>
<span class="sd">            colorkey : tuple</span>
<span class="sd">                The (r, g, b) color that should be used as colorkey (or magic color).</span>
<span class="sd">                Default: None</span>

<span class="sd">        :rtype: image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">u&#39;This should be implemented in a inherited class&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_image_file_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_like_obj</span><span class="p">,</span> <span class="n">colorkey</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="c"># -&gt; image</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        Load a image from a file like object.</span>

<span class="sd">        :Parameters:</span>
<span class="sd">            file_like_obj : file</span>
<span class="sd">                This is the file like object to load the image from.</span>
<span class="sd">            colorkey : tuple</span>
<span class="sd">                The (r, g, b) color that should be used as colorkey (or magic color).</span>
<span class="sd">                Default: None</span>

<span class="sd">        :rtype: image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">u&#39;This should be implemented in a inherited class&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_image_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">tilewidth</span><span class="p">,</span> <span class="n">tileheight</span><span class="p">,</span> <span class="n">colorkey</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="c">#-&gt; [images]</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        Load different tile images from one source image.</span>

<span class="sd">        :Parameters:</span>
<span class="sd">            filename : string</span>
<span class="sd">                Path to image to be loaded.</span>
<span class="sd">            margin : int</span>
<span class="sd">                The margin around the image.</span>
<span class="sd">            spacing : int</span>
<span class="sd">                The space between the tile images.</span>
<span class="sd">            tilewidth : int</span>
<span class="sd">                The width of a single tile.</span>
<span class="sd">            tileheight : int</span>
<span class="sd">                The height of a single tile.</span>
<span class="sd">            colorkey : tuple</span>
<span class="sd">                The (r, g, b) color that should be used as colorkey (or magic color).</span>
<span class="sd">                Default: None</span>

<span class="sd">        Luckily that iteration is so easy in python::</span>

<span class="sd">            ...</span>
<span class="sd">            w, h = image_size</span>
<span class="sd">            for y in xrange(margin, h, tileheight + spacing):</span>
<span class="sd">                for x in xrange(margin, w, tilewidth + spacing):</span>
<span class="sd">                    ...</span>

<span class="sd">        :rtype: a list of images</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">u&#39;This should be implemented in a inherited class&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AbstractResourceLoader.load"><a class="viewcode-back" href="../../tiledtmxloader.html#tiledtmxloader.tiledtmxloader.AbstractResourceLoader.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_map</span><span class="p">):</span>
        <span class="sd">u&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_map</span> <span class="o">=</span> <span class="n">tile_map</span>
        <span class="k">for</span> <span class="n">tile_set</span> <span class="ow">in</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">tile_sets</span><span class="p">:</span>
            <span class="c"># do images first, because tiles could reference it</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">tile_set</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_from_source</span><span class="p">(</span><span class="n">tile_map</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tile_set</span><span class="o">.</span><span class="n">indexed_images</span><span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_tile_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="c"># tiles</span>
            <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">tile_set</span><span class="o">.</span><span class="n">tiles</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">tile</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">img</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">img</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
                        <span class="c"># only image id set</span>
                        <span class="n">indexed_img</span> <span class="o">=</span> <span class="n">tile_set</span><span class="o">.</span><span class="n">indexed_images</span><span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">indexed_tiles</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tile_set</span><span class="o">.</span><span class="n">firstgid</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indexed_img</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_from_source</span><span class="p">(</span><span class="n">tile_map</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">indexed_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_tile_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">indexed_tiles</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tile_set</span><span class="o">.</span><span class="n">firstgid</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indexed_img</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_load_image_from_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_map</span><span class="p">,</span> <span class="n">tile_set</span><span class="p">,</span> <span class="n">a_tile_image</span><span class="p">):</span>
        <span class="c"># relative path to file</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">tile_map</span><span class="o">.</span><span class="n">map_file_name</span><span class="p">),</span> <span class="n">a_tile_image</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="n">tile_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_map</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">)</span>
        <span class="n">tile_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_map</span><span class="o">.</span><span class="n">tileheight</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tile_set</span><span class="o">.</span><span class="n">tileheight</span><span class="p">:</span>
            <span class="n">tile_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_set</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tile_set</span><span class="o">.</span><span class="n">tilewidth</span><span class="p">:</span>
            <span class="n">tile_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tile_set</span><span class="o">.</span><span class="n">tileheight</span><span class="p">)</span>
        <span class="n">offsetx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">offsety</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># the offset is used for pygame because the origin is topleft in pygame</span>
        <span class="k">if</span> <span class="n">tile_height</span> <span class="o">&gt;</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">tileheight</span><span class="p">:</span>
            <span class="n">offsety</span> <span class="o">=</span> <span class="n">tile_height</span> <span class="o">-</span> <span class="n">tile_map</span><span class="o">.</span><span class="n">tileheight</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_parts</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> \
                    <span class="n">tile_set</span><span class="o">.</span><span class="n">margin</span><span class="p">,</span> <span class="n">tile_set</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">tile_width</span><span class="p">,</span> <span class="n">tile_height</span><span class="p">,</span> <span class="n">a_tile_image</span><span class="o">.</span><span class="n">trans</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexed_tiles</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tile_set</span><span class="o">.</span><span class="n">firstgid</span><span class="p">)</span> <span class="o">+</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offsetx</span><span class="p">,</span> <span class="o">-</span><span class="n">offsety</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_load_tile_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_tile_image</span><span class="p">):</span>
        <span class="n">img_str</span> <span class="o">=</span> <span class="n">a_tile_image</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="n">a_tile_image</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_tile_image</span><span class="o">.</span><span class="n">encoding</span> <span class="o">==</span> <span class="s">u&#39;base64&#39;</span><span class="p">:</span>
                <span class="n">img_str</span> <span class="o">=</span> <span class="n">decode_base64</span><span class="p">(</span><span class="n">a_tile_image</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">u&#39;unknown image encoding </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">a_tile_image</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">sio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">img_str</span><span class="p">)</span>
        <span class="n">new_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_image_file_like</span><span class="p">(</span><span class="n">sio</span><span class="p">,</span> <span class="n">a_tile_image</span><span class="o">.</span><span class="n">trans</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_image</span>

<span class="c">#  -----------------------------------------------------------------------------</span>
</div>
<span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
    <span class="n">_DELTA</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">_START_TIME</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> loaded: </span><span class="si">%f</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="n">_DELTA</span><span class="p">))</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pytmxloader 3.0.1.97 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, DR0ID.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>